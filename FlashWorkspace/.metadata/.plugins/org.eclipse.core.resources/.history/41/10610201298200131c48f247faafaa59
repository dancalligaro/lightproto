package
{
  import flash.external.ExternalInterface;
  import flash.display.Sprite;
  import flash.media.Camera;
  import flash.media.Video;
  import flash.display.BitmapData;
  import flash.utils.setInterval;
   import flash.text.*;
   import flash.events.StatusEvent;
   

  [SWF(frameRate='5', width='320', height='240', backgroundColor='#FFFFFF')]
  public class CameraRequest extends Sprite
  {
    protected var webcam:Camera;
    protected var video:Video;

    public function CameraRequest()
    {
      openCamera(0);
    }

    public function openCamera(camIndex:int):void
    {
      webcam=Camera.getCamera();
      if (!webcam)
      {
      	ExternalInterface.call('flashWebcam.noWebcamAvailable');
      }else{
	      webcam.addEventListener(StatusEvent.STATUS, statusHandler); 
	      webcam.setMode(320, 240, 15);
	      video=new Video(320, 240);
	      video.attachCamera(webcam);
	      addChild(video);
	      ExternalInterface.call('console.log', 'camera loaded');
      }
    }

	public function statusHandler(event:StatusEvent):void 
	{ 
	    // This event gets dispatched when the user clicks the "Allow" or "Deny" 
	    // button in the Flash Player Settings dialog box. 
	    trace(event.code); // "Camera.Muted" or "Camera.Unmuted"
	    
	    ExternalInterface.call('flashWebcam.statusChanged', event.code);
	    
	     setInterval (watchPixels, 1000);
	    
	}

	public function watchPixels():void{
	
		var bd:BitmapData = new BitmapData(320,240);
		var pixel:uint;
		
		webcam.drawToBitmapData(bd);
		pixel = bd.getPixel(10,10);
	
		ExternalInterface.call('flashWebcam.lightLevel', pixel);
	}

    /*public function drawCapture(image:BitmapData):void
    {
      image.draw(video);
    }
    */
  }
}

