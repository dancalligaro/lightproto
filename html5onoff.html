<!doctype html>
<html>
<head>
	<title>HTML5</title>
	<script src="jquery-1.10.2.js"></script>
	<script src="underscore.js"></script>
	<style>
		body{
			font-family: arial;
			color: #666;
		}
		.videoContainer{
			margin: 10px;
			border: solid 1px #aaa;
			min-height: 100px;
		}
		.hideCamera{
			position: absolute;
			top: -1000px;
		}
		#levelCont{
			display: none;
			width: 200px;
			height: 30px;
			border: solid 2px #aaa;
			position: relative;
		}
		#levelIndicator{
			position: absolute;
			top:0 ;
			left: 0;
			width: 50%;
			background: green;
			height: 30px;
		}
		#text{
			position: absolute;
		}
	</style>

</head>

<body>

	<div id="loader">Loading...</div>

	<div>
		<input type="button" id="startCam" value="Start Camera" />
		<div id="levelCont">
			<div id="levelIndicator"></div>
			<div id="text">light level <span></span></div>
		</div>
	</div>

	<div id='playButtons' style="display: none;">
		<input type="button" data-vid="vid1" value="play"/>
		<input type="button" data-vid="vid2" value="play"/>
	</div>

	<video id='vid1' width="960" height="540" preload="auto" style="display: none;">
		<source src="http://dvwpvl2pxg55z.cloudfront.net/VID_20140121_152726_1_1.mp4" type="video/mp4">
		<source src="http://dvwpvl2pxg55z.cloudfront.net/VID_720_1625.ogv" type="video/ogg">
	</video>

 	<video id='vid2' width="960" height="540" preload="auto" style="display: none;">
		<source src="http://dvwpvl2pxg55z.cloudfront.net/test720_1625_1.mp4" type="video/mp4">
		<source src="http://dvwpvl2pxg55z.cloudfront.net/test720_1625.ogv" type="video/ogg">
	</video>

	<div id="flashWebcamPlayer">
		<object id="flashWebcamElement" data="FlashWorkspace/WebCamApp/bin/CameraRequest.swf"
		type="application/x-shockwave-flash" width="320" height="240" >
		<param name="movie" value="FlashWorkspace/WebCamApp/bin/CameraRequest.swf" />
		</object>
	</div>

<script>
	var vid1 = $('#vid1')[0], vid2 = $('#vid2')[0];
	var playing1 = false;
	var enoughLoaded = false;
	
	var playButtons = $("#playButtons input");
	playButtons.click(function(){
		var self = this;
		playButtons.each(function(){
			var videoObj = $("#" + $(this).attr('data-vid'));
			if(videoObj.attr('id') == $(self).attr('data-vid')){
				videoObj.show();
				videoObj[0].play();
			}else{
				videoObj.hide()
				videoObj[0].pause();
				videoObj[0].currentTime = 0;
			}
		});

	});

	function addSourceToVideo(element, src, type) {
	    var source = document.createElement('source');
	    source.src = src;
	    source.type = type;
	    element.appendChild(source);
	}

	function checkCanStart(){
		var totalPercent = 0;
		var canPlay = false;
		var videos = $('video');
		var loadedVideos = 0;

		var completedString = ""; 

		videos.each(function(){
			var self = this;

			if(self.duration && self.buffered.length){
				var loadedPercent = self.buffered.end(0) * 100/self.duration;
				totalPercent += loadedPercent;
				if(self.buffered.end(0) > 7.5){
					loadedVideos++;
				}
				completedString += $(self).attr('id') + " - Loaded: " + loadedPercent.toFixed(0) + "% - Buffered:" + self.buffered.end(0).toFixed(2) + "s<br />"
			}else{
				completedString += $(self).attr('id') + ": no info <br />"
			}

		})

		completedString += "Overall: " + (totalPercent/ videos.length).toFixed(0) + "%" ;
		$('#loader').html( completedString);

		if(loadedVideos == videos.length){
			enoughLoaded = true;
			clearInterval(checkInt);
		}
	}
	 
	var video;
	var index = 0;
	$(document).ready(function(){

		//video = document.getElementsByTagName('video')[0];
		$('video').each(function(){
			console.log('can we check here')
			checkCanStart(); //When video is cached
			$(this).on('progress', function(){
				checkCanStart();
			})
		})
	 
	});
	 
var checkInt = setInterval(function(){
	checkCanStart();
},1000)

	window.flashWebcam = {
		currentStatus: "on",
		statusChanged: function(statusCode){
			if(statusCode=="Camera.Unmuted"){
				$("#startCam").hide();
				$("#levelCont").show();
				document.getElementById('flashWebcamPlayer').className = "hideCamera"
				window.runVideo();

			}else{
				alert('Camera Access Rejected')
			}
		}, 
		noWebcamAvailable: function(){
			alert('No webcam available')
		}, 
		lightLevel: function(level){

			var levelper = (level*100/255);

			$('#text span').html(levelper.toFixed(0))
			$('#levelIndicator').css({'width': levelper +'%'})

			if(levelper > 25){
				$('#levelIndicator').css({'background': 'green'})
				if(window.flashWebcam.currentStatus == "off"){
					if(window.flashWebcam.turnOn) {
						window.flashWebcam.currentStatus = "on";
						window.flashWebcam.turnOn();
					}
				}
			}else{
				$('#levelIndicator').css({'background': 'red'})
				if(window.flashWebcam.currentStatus == "on"){
					if(window.flashWebcam.turnOff) {
						window.flashWebcam.currentStatus = "off";
						window.flashWebcam.turnOff();
					}
				}
			}
		}
	};

$('#startCam').click(function(){
	$("#flashWebcamElement").get(0).startCamera();
	
	window.flashWebcam.turnOn = function(){
		$('#playButtons input:eq(0)').click();
	};
	
	window.flashWebcam.turnOff = function(){
		$('#playButtons input:eq(1)').click();
	};
})


</script>

</body>
</html>